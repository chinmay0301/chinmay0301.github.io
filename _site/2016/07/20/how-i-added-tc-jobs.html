<!DOCTYPE html>
<html>

  <head>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>GSoC 2016 - How I added TaskCluster Jobs to Treeherder!</title>
  <meta name="description" content="This is a technical blog and describes the technical details behind the GSoC project. In case you wish to see a developer’s guide to use this feature only, k...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://chinmay0301.github.io/2016/07/20/how-i-added-tc-jobs.html">
  <link rel="alternate" type="application/rss+xml" title="Chinmay Talegaonkar" href="http://chinmay0301.github.io/feed.xml">
</head>

    

    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>GSoC 2016 - How I added TaskCluster Jobs to Treeherder! | Chinmay Talegaonkar</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="GSoC 2016 - How I added TaskCluster Jobs to Treeherder!" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is a technical blog and describes the technical details behind the GSoC project. In case you wish to see a developer’s guide to use this feature only, kindly refer to this. Lastly, there is a post with a list of all the PRs in the project." />
<meta property="og:description" content="This is a technical blog and describes the technical details behind the GSoC project. In case you wish to see a developer’s guide to use this feature only, kindly refer to this. Lastly, there is a post with a list of all the PRs in the project." />
<link rel="canonical" href="http://chinmay0301.github.io/2016/07/20/how-i-added-tc-jobs.html" />
<meta property="og:url" content="http://chinmay0301.github.io/2016/07/20/how-i-added-tc-jobs.html" />
<meta property="og:site_name" content="Chinmay Talegaonkar" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-07-20T23:00:55+05:30" />
<script type="application/ld+json">
{"url":"http://chinmay0301.github.io/2016/07/20/how-i-added-tc-jobs.html","headline":"GSoC 2016 - How I added TaskCluster Jobs to Treeherder!","dateModified":"2016-07-20T23:00:55+05:30","datePublished":"2016-07-20T23:00:55+05:30","description":"This is a technical blog and describes the technical details behind the GSoC project. In case you wish to see a developer’s guide to use this feature only, kindly refer to this. Lastly, there is a post with a list of all the PRs in the project.","mainEntityOfPage":{"@type":"WebPage","@id":"http://chinmay0301.github.io/2016/07/20/how-i-added-tc-jobs.html"},"@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    
      <meta content="https://avatars1.githubusercontent.com/u/8805240" property="og:image" />
    
  </head>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Chinmay Talegaonkar</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/archive.html">Blog</a>
          
        
          
          <a class="page-link" href="/cv/">CV</a>
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/projects/"><!-- Projects --></a>
          
        
          
          <a class="page-link" href="/research/">Research</a>
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">GSoC 2016 - How I added TaskCluster Jobs to Treeherder!</h1>
    <p class="post-meta"><time datetime="2016-07-20T23:00:55+05:30" itemprop="datePublished">Jul 20, 2016</time> </p>
    

  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This is a technical blog and describes the technical details behind the GSoC project. In case you wish to see a <a href="https://wiki.mozilla.org/ReleaseEngineering/TryServer#How_to_push_to_try">developer’s guide</a> to <strong>use</strong> this feature only, kindly refer to this. Lastly, there is a <a href="/2016/07/20/gsoc-code-review.html">post</a> with a list of all the PRs in the project.</p>

<h2 id="treeherder">Treeherder</h2>

<p>Since the “Add New Jobs” feature had been done earlier for BuildBot jobs, my major goal has been to create a parallel approach for TaskCluster jobs.</p>

<p>Unlike BuildBot jobs, TaskCluster jobs do not have a <code class="highlighter-rouge">buildername</code> property which can be used to uniquely identify a certain job. However, Dustin’s big-graph changes introduced <code class="highlighter-rouge">full-task-graph.json</code>, which has the magical <code class="highlighter-rouge">TaskLabel</code>. A typical task label looks like this - <code class="highlighter-rouge">TaskLabel==A1gDl4RUQriAf28c6gkuCw</code>.</p>

<p>Now task labels uniquely identify tasks in a push. They differ from task IDs. So if a single push has two tasks which do the same work, they would have identical task labels but different task IDs. Task IDs are produced when tasks are actually created. Another difference is that task labels are consistent across pushes. Task IDs are not, and can uniquely identify a particular task in a particular push.</p>

<p>So now on pressing “Add New Jobs”, I pass the decision task id (only if it’s complete) to the Django API. The API downloads the <code class="highlighter-rouge">full-task-graph.json</code> file and sends back a list having both BuildBot jobs and TaskCluster jobs. <code class="highlighter-rouge">TaskLabel==&lt;...&gt;</code> is used as a <code class="highlighter-rouge">ref_name</code> to uniquely identify jobs.</p>

<p>Hence, the code for BuildBot is reused without further additions. However, two major changes have been made in the resulting pulse messages. We are passing down the Decision Task ID and a timestamp along with the list of requested jobs’ <code class="highlighter-rouge">ref_name</code>s, which would be <code class="highlighter-rouge">buildername</code> for BB and <code class="highlighter-rouge">TaskLabel==&lt;...&gt;</code> for TaskCluster.</p>

<p>TaskCluster jobs only show on <code class="highlighter-rouge">try</code> pushes due to a UI restriction imposed. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1286894">Bug 1286894</a> has been filed to decide how to implement this feature on other repositories.</p>

<p>You can go ahead and try out the “Add New Jobs” feature. You can see the Pulse messages on <a href="https://tools.taskcluster.net/pulse-inspector/#!((exchange:exchange/treeherder/v1/resultset-runnable-job-actions,routingKeyPattern:%23))">this</a> exchange.</p>

<h2 id="pulse-actions--mozci">Pulse Actions / MozCI</h2>

<p>Like before, Pulse Action continues to listen to these pulse messages generated by Treeherder. It now separates TaskCluster job requests by checking whether the <code class="highlighter-rouge">ref_name</code> starts with <code class="highlighter-rouge">TaskLabel==</code> or not.</p>

<p>TaskCluster jobs are then separated. MozCI reads the list of task labels and the Decision Task ID. It downloads <code class="highlighter-rouge">action.yml</code> a file which is YAML representation of Action Tasks (explained in next section). <code class="highlighter-rouge">and</code> are appropriately replaced with the Decision Task ID received in the Pulse Message and a comma separated list of requested task labels.</p>

<p>This is converted to a JSON task and scheduled using python TaskCluster client. The resulting task shows up on Treeherder as an <strong>Action Task</strong>.</p>

<h2 id="taskcluster">TaskCluster</h2>

<p>This describes the technical process in-tree, which enable the scheduling of Action Tasks.</p>

<p>The major change here is the addition of a <code class="highlighter-rouge">mach</code> command, <code class="highlighter-rouge">mach taskgraph action-task</code>. This command accepts two parameters, <code class="highlighter-rouge">decision-id</code> and <code class="highlighter-rouge">task-labels</code>.</p>

<p>This command is parsed and processed in <a href="https://dxr.mozilla.org/mozilla-central/source/taskcluster/taskgraph/action.py">taskcluster/takgraph/action.py</a>. The decision task ID is used to download the full-task-graph file along with the list of exisiting tasks.</p>

<p>Based on the set of task labels requested, the full-task-graph is simplified to leave just the nodes requested along with its dependencies. After this, the graph goes through an optimization procedure where all nodes present in the original push (procured from the task-to-label file in the decision task) are removed unless specially requested by the user.</p>

<p>Once the graph is optimized, the dependencies are replaced with appropriate task IDs and TaskCluster schedules this graph in the same push. The requested jobs then show up on Treeherder.</p>

  </div>

</article>



      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Chinmay Talegaonkar</li>
          <li><a href="mailto:chinmay0301@gmail.com">chinmay0301@gmail.com</a></li>
          <li><a href="mailto:chinmay0301@iitb.ac.in">chinmay0301@iitb.ac.in</a></li>
        </ul>
      </div>
      <div class="footer-col footer-col-1">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/chinmay0301"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">chinmay0301</span></a>

          </li>
          
          
          
          <li>
            <a href="https://www.linkedin.com/in/chinmay0301"><span class="icon icon--linkedin"><svg  x="0px" y="0px" width="16px" height="16px" viewBox="0 50 512 512" style="enable-background:new 0 0 90 90;" xml:space="preserve">
<g>
    <path fill="#828282" d="M150.65,100.682c0,27.992-22.508,50.683-50.273,50.683c-27.765,0-50.273-22.691-50.273-50.683
    C50.104,72.691,72.612,50,100.377,50C128.143,50,150.65,72.691,150.65,100.682z M143.294,187.333H58.277V462h85.017V187.333z
    M279.195,187.333h-81.541V462h81.541c0,0,0-101.877,0-144.181c0-38.624,17.779-61.615,51.807-61.615
    c31.268,0,46.289,22.071,46.289,61.615c0,39.545,0,144.181,0,144.181h84.605c0,0,0-100.344,0-173.915
    s-41.689-109.131-99.934-109.131s-82.768,45.369-82.768,45.369V187.333z"/>
</g>
</svg></span><span class="username">&nbsp;Chinmay Talegaonkar</span></a>

          </li>
          
        </ul>
      </div>
      <div class="footer-col footer-col-4">
        <!-- <p></p> -->
        <ul class="social-media-list">
        
        </ul>
      </div>
      
      
      
    </div>

  </div>

</footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89391111-1', 'auto');
  ga('send', 'pageview');

</script>
    <script id="dsq-count-scr" src="//http-martiansideofthemoon-github-io.disqus.com/count.js" async></script>
  </body>

</html>
